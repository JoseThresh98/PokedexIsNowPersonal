# â”€â”€ Backend Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# File: azure-pipelines-backend.yml
# Place at: /pokedex-api/azure-pipelines-backend.yml
#
# Triggers:
#   - develop branch â†’ deploys to STAGING App Service slot
#   - main branch    â†’ deploys to PRODUCTION App Service
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - pokedex-api/**

pool:
  vmImage: ubuntu-latest

variables:
  - name: dotnetVersion
    value: '8.0.x'
  - name: buildConfiguration
    value: 'Release'
  - name: azureSubscription
    value: 'Azure Subscription 1'           # â† must match your service connection name
  - name: appServiceNameProduction
    value: 'pokedex-api-prod'               # â† your App Service name in Azure
  - name: appServiceNameStaging
    value: 'pokedex-api-staging'            # â† staging App Service name
  - name: resourceGroup
    value: 'pokedex-rg'                     # â† your resource group name

stages:

# â”€â”€ Stage 1: Build & Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Build
  displayName: 'ğŸ”¨ Build .NET API'
  jobs:
  - job: BuildJob
    displayName: 'Build, Test & Publish'
    steps:

    - task: UseDotNet@2
      displayName: 'Install .NET $(dotnetVersion)'
      inputs:
        packageType: sdk
        version: $(dotnetVersion)

    - script: |
        cd pokedex-api
        dotnet restore
      displayName: 'ğŸ“¦ Restore NuGet packages'

    - script: |
        cd pokedex-api
        dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'âš™ï¸ Build solution'

    - script: |
        cd pokedex-api
        dotnet publish --configuration $(buildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/api
      displayName: 'ğŸ“¦ Publish API'

    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¤ Upload artifact'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/api'
        ArtifactName: 'backend-api'
        publishLocation: 'Container'

# â”€â”€ Stage 2: Deploy Staging (develop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: DeployStaging
  displayName: 'ğŸš§ Deploy â†’ Staging'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: DeployStaging
    displayName: 'Deploy API to Staging'
    environment: 'pokedex-api-staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'backend-api'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: AzureWebApp@1
            displayName: 'ğŸš€ Deploy to Staging App Service'
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webAppLinux
              appName: $(appServiceNameStaging)
              package: '$(System.ArtifactsDirectory)/backend-api'
              runtimeStack: 'DOTNETCORE|8.0'

# â”€â”€ Stage 3: Deploy Production (main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: DeployProduction
  displayName: 'ğŸŒŸ Deploy â†’ Production'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployProduction
    displayName: 'Deploy API to Production'
    environment: 'pokedex-production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'backend-api'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: AzureWebApp@1
            displayName: 'ğŸš€ Deploy to Production App Service'
            inputs:
              azureSubscription: $(azureSubscription)
              appType: webAppLinux
              appName: $(appServiceNameProduction)
              package: '$(System.ArtifactsDirectory)/backend-api'
              runtimeStack: 'DOTNETCORE|8.0'
