# â”€â”€ PokÃ©dex 2.0 Frontend Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# File: azure-pipelines-frontend.yml
# Place at: repo ROOT (same level as pokedex-frontend folder)
#
# develop branch â†’ Staging
# main branch    â†’ Production
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - pokedex-frontend/**
      - azure-pipelines-frontend.yml

pool:
  vmImage: ubuntu-latest

variables:
  - group: pokedex-secrets
  - name: VITE_APP_VERSION
    value: '2.0.0'
  - name: nodeVersion
    value: '20.x'

stages:

# â”€â”€ Stage 1: Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Build
  displayName: 'ğŸ”¨ Build React App'
  jobs:
  - job: BuildJob
    displayName: 'Install, Build & Publish Artifact'
    steps:

    - task: NodeTool@0
      displayName: 'Use Node.js $(nodeVersion)'
      inputs:
        versionSpec: $(nodeVersion)

    - script: |
        cd pokedex-frontend
        npm ci
      displayName: 'ğŸ“¦ Install dependencies'

    - script: |
        cd pokedex-frontend
        npm run build
      displayName: 'âš™ï¸  Vite build'
      env:
        VITE_APP_VERSION: $(VITE_APP_VERSION)

    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¤ Upload dist artifact'
      inputs:
        PathtoPublish: 'pokedex-frontend/dist'
        ArtifactName: 'frontend-dist'
        publishLocation: 'Container'

# â”€â”€ Stage 2: Deploy Staging (develop branch) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: DeployStaging
  displayName: 'ğŸš§ Deploy â†’ Staging'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: DeployStaging
    displayName: 'Deploy to Staging'
    environment: 'pokedex-staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'ğŸ“¥ Download artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'frontend-dist'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: AzureStaticWebApp@0
            displayName: 'ğŸš€ Deploy to Azure Static Web Apps (Staging)'
            inputs:
              azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING)
              app_location: '$(System.ArtifactsDirectory)/frontend-dist'
              skip_app_build: true
              deployment_environment: 'staging'

# â”€â”€ Stage 3: Deploy Production (main branch) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: DeployProduction
  displayName: 'ğŸŒŸ Deploy â†’ Production'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployProduction
    displayName: 'Deploy to Production'
    environment: 'pokedex-production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'ğŸ“¥ Download artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'frontend-dist'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: AzureStaticWebApp@0
            displayName: 'ğŸš€ Deploy to Azure Static Web Apps (Production)'
            inputs:
              azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION)
              app_location: '$(System.ArtifactsDirectory)/frontend-dist'
              skip_app_build: true
